import React, { useState, useEffect, useRef } from 'react';
import { Mic, MicOff, Play, Pause, RotateCcw, Award, Volume2 } from 'lucide-react';

const KArticulationApp = () => {
  // Kelime verileri - her pozisyon için 5 örnek
  const words = {
    baş: [
      { word: 'kalem', image: '✏️', description: 'Kalem' },
      { word: 'kedi', image: '🐱', description: 'Kedi' },
      { word: 'kafa', image: '👤', description: 'Kafa' },
      { word: 'kapı', image: '🚪', description: 'Kapı' },
      { word: 'kare', image: '⬜', description: 'Kare' }
    ],
    orta: [
      { word: 'diken', image: '🌹', description: 'Diken' },
      { word: 'teker', image: '⚪', description: 'Teker' },
      { word: 'çilek', image: '🍓', description: 'Çilek' },
      { word: 'börek', image: '🥧', description: 'Börek' },
      { word: 'paket', image: '📦', description: 'Paket' }
    ],
    son: [
      { word: 'çocuk', image: '👶', description: 'Çocuk' },
      { word: 'büyük', image: '📏', description: 'Büyük' },
      { word: 'küçük', image: '🔍', description: 'Küçük' },
      { word: 'sıcak', image: '🔥', description: 'Sıcak' },
      { word: 'soğuk', image: '❄️', description: 'Soğuk' }
    ]
  };

  // Meyve hafıza oyunu için veriler
  const fruits = ['🍎', '🍌', '🍇', '🍊', '🍓', '🥝', '🍑', '🍒', '🥭', '🍍', '🥥', '🫐'];

  const [currentPosition, setCurrentPosition] = useState('baş');
  const [currentWordIndex, setCurrentWordIndex] = useState(0);
  const [isRecording, setIsRecording] = useState(false);
  const [mediaRecorder, setMediaRecorder] = useState(null);
  const [audioContext, setAudioContext] = useState(null);
  const [analyser, setAnalyser] = useState(null);
  const [showResult, setShowResult] = useState(false);
  const [isCorrect, setIsCorrect] = useState(false);
  const [showMemoryGame, setShowMemoryGame] = useState(false);
  const [memoryCards, setMemoryCards] = useState([]);
  const [flippedCards, setFlippedCards] = useState([]);
  const [matchedCards, setMatchedCards] = useState([]);
  const [memoryTimer, setMemoryTimer] = useState(15);
  const [stats, setStats] = useState({
    baş: { correct: 0, total: 0 },
    orta: { correct: 0, total: 0 },
    son: { correct: 0, total: 0 }
  });

  const audioRef = useRef(null);
  const animationFrameRef = useRef(null);

  // Mikrofon izni ve başlatma
  const requestMicrophoneAccess = async () => {
    try {
      const stream = await navigator.mediaDevices.getUserMedia({ 
        audio: { 
          echoCancellation: true,
          noiseSuppression: true,
          autoGainControl: true 
        } 
      });
      
      const context = new (window.AudioContext || window.webkitAudioContext)();
      const source = context.createMediaStreamSource(stream);
      const analyserNode = context.createAnalyser();
      
      analyserNode.fftSize = 1024;
      analyserNode.smoothingTimeConstant = 0.8;
      source.connect(analyserNode);
      
      setMediaRecorder({ stream });
      setAudioContext(context);
      setAnalyser(analyserNode);
      
      return true;
    } catch (error) {
      console.error('Mikrofon hatası:', error);
      alert('Mikrofon erişimi gerekli. Tarayıcınızın mikrofon iznini kontrol edin.');
      return false;
    }
  };

  // Ses analizi için basit K sesi tespiti (simüle edilmiş)
  const analyzeKSound = () => {
    if (!analyser) return false;
    
    const bufferLength = analyser.frequencyBinCount;
    const dataArray = new Uint8Array(bufferLength);
    analyser.getByteFrequencyData(dataArray);
    
    // K sesinin karakteristik frekans aralıkları (basitleştirilmiş)
    const kFrequencyRange1 = Math.floor((2000 / 22050) * bufferLength); // 2kHz civarı
    const kFrequencyRange2 = Math.floor((4000 / 22050) * bufferLength); // 4kHz civarı
    
    let kSoundDetected = false;
    let averageAmplitude = 0;
    
    // Genel ses seviyesini kontrol et
    for (let i = 0; i < bufferLength; i++) {
      averageAmplitude += dataArray[i];
    }
    averageAmplitude /= bufferLength;
    
    // K sesi frekans aralıklarında güçlü sinyal var mı kontrol et
    if (averageAmplitude > 50 && 
        (dataArray[kFrequencyRange1] > 100 || dataArray[kFrequencyRange2] > 100)) {
      kSoundDetected = true;
    }
    
    // Rastgele doğruluk ekle (gerçek uygulamada daha sofistike olacak)
    return Math.random() > 0.3 ? kSoundDetected : !kSoundDetected;
  };

  // Kayıt başlat/durdur
  const toggleRecording = async () => {
    if (!mediaRecorder) {
      const success = await requestMicrophoneAccess();
      if (!success) return;
    }

    if (!isRecording) {
      setIsRecording(true);
      setShowResult(false);
      
      // 2 saniye sonra analiz yap
      setTimeout(() => {
        const correct = analyzeKSound();
        setIsCorrect(correct);
        setShowResult(true);
        setIsRecording(false);
        
        // İstatistikleri güncelle
        setStats(prev => ({
          ...prev,
          [currentPosition]: {
            correct: prev[currentPosition].correct + (correct ? 1 : 0),
            total: prev[currentPosition].total + 1
          }
        }));
        
        if (correct) {
          // Doğru ise hafıza oyununu başlat
          setTimeout(() => {
            startMemoryGame();
          }, 1000);
        } else {
          // Yanlış ise 2 saniye sonra yeni örneğe geç
          setTimeout(() => {
            nextWord();
          }, 2000);
        }
      }, 2000);
    }
  };

  // Hafıza oyununu başlat
  const startMemoryGame = () => {
    const selectedFruits = fruits.slice(0, 6);
    const gameCards = [...selectedFruits, ...selectedFruits]
      .sort(() => Math.random() - 0.5)
      .map((fruit, index) => ({
        id: index,
        fruit,
        isFlipped: false,
        isMatched: false
      }));
    
    setMemoryCards(gameCards);
    setFlippedCards([]);
    setMatchedCards([]);
    setMemoryTimer(15);
    setShowMemoryGame(true);
  };

  // Hafıza oyunu timer
  useEffect(() => {
    let timer;
    if (showMemoryGame && memoryTimer > 0) {
      timer = setTimeout(() => {
        setMemoryTimer(prev => prev - 1);
      }, 1000);
    } else if (showMemoryGame && memoryTimer === 0) {
      // 15 saniye bitince oyunu kapat ve yeni kelimeye geç
      setShowMemoryGame(false);
      setTimeout(() => {
        nextWord();
      }, 500);
    }
    return () => clearTimeout(timer);
  }, [showMemoryGame, memoryTimer]);

  // Hafıza oyunu kart tıklama
  const handleCardClick = (cardId) => {
    if (flippedCards.length === 2) return;
    if (flippedCards.includes(cardId)) return;
    if (matchedCards.includes(cardId)) return;

    const newFlipped = [...flippedCards, cardId];
    setFlippedCards(newFlipped);

    if (newFlipped.length === 2) {
      const [first, second] = newFlipped;
      const firstCard = memoryCards.find(c => c.id === first);
      const secondCard = memoryCards.find(c => c.id === second);

      if (firstCard.fruit === secondCard.fruit) {
        setMatchedCards(prev => [...prev, first, second]);
        setFlippedCards([]);
      } else {
        setTimeout(() => {
          setFlippedCards([]);
        }, 1000);
      }
    }
  };

  // Yeni kelimeye geç
  const nextWord = () => {
    setShowResult(false);
    setShowMemoryGame(false);
    
    const currentWords = words[currentPosition];
    if (currentWordIndex < currentWords.length - 1) {
      setCurrentWordIndex(prev => prev + 1);
    } else {
      // Bu pozisyondaki kelimeler bittiyse bir sonraki pozisyona geç
      const positions = ['baş', 'orta', 'son'];
      const currentPosIndex = positions.indexOf(currentPosition);
      if (currentPosIndex < positions.length - 1) {
        setCurrentPosition(positions[currentPosIndex + 1]);
        setCurrentWordIndex(0);
      } else {
        // Tüm kelimeler bittiyse başa dön
        setCurrentPosition('baş');
        setCurrentWordIndex(0);
      }
    }
  };

  // Mevcut kelime
  const currentWord = words[currentPosition][currentWordIndex];

  // Kelimeyi seslendir (TTS)
  const speakWord = () => {
    if ('speechSynthesis' in window) {
      const utterance = new SpeechSynthesisUtterance(currentWord.word);
      utterance.lang = 'tr-TR';
      utterance.rate = 0.8;
      speechSynthesis.speak(utterance);
    }
  };

  return (
    <div className="min-h-screen bg-gradient-to-br from-blue-400 via-purple-500 to-pink-500 p-4">
      <div className="max-w-4xl mx-auto">
        {/* Header */}
        <div className="bg-white rounded-2xl shadow-lg p-6 mb-6">
          <h1 className="text-3xl font-bold text-center text-gray-800 mb-4">
            K Sesi Artikülasyon Çalışması
          </h1>
          
          {/* Pozisyon seçici */}
          <div className="flex justify-center space-x-4 mb-4">
            {['baş', 'orta', 'son'].map((pos) => (
              <button
                key={pos}
                onClick={() => {
                  setCurrentPosition(pos);
                  setCurrentWordIndex(0);
                  setShowResult(false);
                  setShowMemoryGame(false);
                }}
                className={`px-6 py-2 rounded-full font-semibold transition-all ${
                  currentPosition === pos
                    ? 'bg-blue-500 text-white shadow-md'
                    : 'bg-gray-200 text-gray-700 hover:bg-gray-300'
                }`}
              >
                {pos.charAt(0).toUpperCase() + pos.slice(1)}
              </button>
            ))}
          </div>

          {/* İstatistikler */}
          <div className="grid grid-cols-3 gap-4 text-center text-sm">
            {['baş', 'orta', 'son'].map((pos) => (
              <div key={pos} className="bg-gray-50 rounded-lg p-3">
                <div className="font-semibold text-gray-700 capitalize">{pos}</div>
                <div className="text-lg font-bold text-green-600">
                  {stats[pos].correct}/{stats[pos].total}
                </div>
              </div>
            ))}
          </div>
        </div>

        {!showMemoryGame ? (
          /* Ana çalışma ekranı */
          <div className="bg-white rounded-2xl shadow-lg p-8">
            {/* Kelime gösterimi */}
            <div className="text-center mb-8">
              <div className="text-8xl mb-4">{currentWord.image}</div>
              <h2 className="text-4xl font-bold text-gray-800 mb-2">
                {currentWord.description}
              </h2>
              <button
                onClick={speakWord}
                className="bg-blue-500 hover:bg-blue-600 text-white p-3 rounded-full transition-all"
              >
                <Volume2 size={24} />
              </button>
            </div>

            {/* Pozisyon bilgisi */}
            <div className="text-center mb-6">
              <div className="inline-block bg-yellow-100 px-4 py-2 rounded-full">
                <span className="text-yellow-800 font-semibold">
                  K sesi {currentPosition} pozisyonunda
                </span>
              </div>
            </div>

            {/* Mikrofon kontrolü */}
            <div className="text-center mb-8">
              <button
                onClick={toggleRecording}
                disabled={isRecording}
                className={`w-24 h-24 rounded-full flex items-center justify-center transition-all text-white text-2xl shadow-lg ${
                  isRecording
                    ? 'bg-red-500 animate-pulse'
                    : 'bg-green-500 hover:bg-green-600 hover:scale-105'
                }`}
              >
                {isRecording ? <MicOff size={36} /> : <Mic size={36} />}
              </button>
              <p className="mt-4 text-lg text-gray-600">
                {isRecording ? 'Dinliyorum...' : 'Kelimeyi söylemek için tıklayın'}
              </p>
            </div>

            {/* Sonuç gösterimi */}
            {showResult && (
              <div className="text-center">
                <div className={`text-6xl mb-4 ${isCorrect ? 'animate-bounce' : 'animate-pulse'}`}>
                  {isCorrect ? '🎉' : '❌'}
                </div>
                <p className={`text-2xl font-bold ${isCorrect ? 'text-green-600' : 'text-red-600'}`}>
                  {isCorrect ? 'Harika! K sesini doğru söyledin!' : 'Tekrar deneyelim!'}
                </p>
                {isCorrect && (
                  <p className="text-lg text-gray-600 mt-2">
                    Ödül oyunu başlıyor...
                  </p>
                )}
              </div>
            )}
          </div>
        ) : (
          /* Hafıza oyunu */
          <div className="bg-white rounded-2xl shadow-lg p-8">
            <div className="text-center mb-6">
              <div className="flex items-center justify-center space-x-4 mb-4">
                <Award className="text-yellow-500" size={32} />
                <h2 className="text-3xl font-bold text-gray-800">Ödül Zamanı!</h2>
                <Award className="text-yellow-500" size={32} />
              </div>
              <p className="text-lg text-gray-600">
                Meyve çiftlerini bul! Süre: <span className="font-bold text-red-600">{memoryTimer}</span>
              </p>
            </div>

            <div className="grid grid-cols-4 gap-4 max-w-md mx-auto">
              {memoryCards.map((card) => (
                <button
                  key={card.id}
                  onClick={() => handleCardClick(card.id)}
                  className={`w-16 h-16 rounded-lg text-2xl transition-all transform hover:scale-105 ${
                    flippedCards.includes(card.id) || matchedCards.includes(card.id)
                      ? 'bg-white border-2 border-yellow-400'
                      : 'bg-gradient-to-br from-purple-400 to-pink-400 hover:from-purple-500 hover:to-pink-500'
                  }`}
                >
                  {flippedCards.includes(card.id) || matchedCards.includes(card.id)
                    ? card.fruit
                    : '?'
                  }
                </button>
              ))}
            </div>
          </div>
        )}

        {/* Progress */}
        <div className="mt-6 bg-white rounded-2xl shadow-lg p-4">
          <div className="flex justify-between items-center text-sm text-gray-600">
            <span>İlerleme: {currentPosition} - {currentWordIndex + 1}/5</span>
            <span>
              Toplam: {Object.values(stats).reduce((acc, stat) => acc + stat.correct, 0)}/
              {Object.values(stats).reduce((acc, stat) => acc + stat.total, 0)}
            </span>
          </div>
          <div className="w-full bg-gray-200 rounded-full h-2 mt-2">
            <div
              className="bg-gradient-to-r from-green-400 to-blue-500 h-2 rounded-full transition-all"
              style={{
                width: `${((currentWordIndex + 1) / 5) * (100 / 3) + 
                  (['baş', 'orta', 'son'].indexOf(currentPosition) * 100 / 3)}%`
              }}
            ></div>
          </div>
        </div>
      </div>
    </div>
  );
};

export default KArticulationApp;
